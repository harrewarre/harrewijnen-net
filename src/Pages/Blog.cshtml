@page "{slug?}"

@using Microsoft.ApplicationInsights

@using Blog.Post;
@using Blog.OpenGraphSupport;

@inject IPostResolver _postResolver;
@inject TelemetryClient _telemetryClient;

@{
    var slug = RouteData.Values["slug"] as string;
    var isEmptySlug = string.IsNullOrWhiteSpace(slug);
    
    if (isEmptySlug)
    {
        _telemetryClient.TrackEvent("blogpost_no_slug");
        Response.Redirect("/404");
        return;
    }

    var post = _postResolver.GetPost(slug);

    if(post == null)
    {
        _telemetryClient.TrackEvent("blogpost_not_found", new Dictionary<string, string> { { "slug", slug } });
        Response.Redirect("/404");
        return;
    }

    _telemetryClient.TrackEvent("blogpost_viewed", new Dictionary<string, string> { { "slug", slug } });
    ViewData["Title"] = post.Metadata.Title;
}

@section Head{
    @{
        var url = $"{Request.Scheme}://{Request.Host.Value}/blog/{slug}";  
        var graphData = new OpenGraphData(post.Metadata.Title, post.Metadata.Summary, url, "article");
    }

    <partial name="_OpenGraph" model="graphData"></partial>
}

<main>
    <article class="post">
        @Html.Raw(post.HtmlContent)
    </article>
    <small>
        <span>Posted on <partial name="_FormattedDate" model="post.Metadata.Created"></partial></span><br />
        <span>Tagged <partial name="_TagList" model="post.Metadata.Tags"></partial></span>
    </small>
</main>